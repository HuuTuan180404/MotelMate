<div class="room-management">
  <header class="header">
    <div class="title">
      <h2>ROOM MANAGEMENT</h2>
      <!-- Hiển thị thông tin tổng quan -->
      <div class="summary-info" *ngIf="!isLoading">
        <span class="total-rooms">
          Showing {{ displayedRooms.length }} of {{ totalFilteredRooms }} rooms
          <span *ngIf="totalFilteredRooms !== allRooms.length">
            ({{ allRooms.length }} total)
          </span>
        </span>
      </div>
    </div>
    <div class="right-section">
      <button
        mat-icon-button
        (click)="toggleFilter($event)"
        matTooltip="Filter"
        id="btn-open-filter-panel"
        [class.active]="isFilterPanelOpen"
      >
        <span class="material-symbols-outlined">filter_arrow_right</span>
      </button>
      <div class="search-box">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search</mat-label>
          <input
            matInput
            placeholder="Search rooms, buildings..."
            [(ngModel)]="searchText"
            (input)="onSearchBar($event)"
            #input
          />
          <mat-icon matSuffix>search</mat-icon>
          <!-- Clear search button -->
          <button
            mat-icon-button
            matSuffix
            *ngIf="searchText"
            (click)="resetSearch('',{target: {value: ''}})"
            matTooltip="Clear search"
          >
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>
      </div>
      <button
        mat-flat-button
        (click)="onClick_btnCreate()"
        class="button create-btn"
        matTooltip="Create room"
      >
        <mat-icon>add</mat-icon>
        <span>Create</span>
      </button>
    </div>
  </header>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading rooms...</p>
  </div>

  <!-- Rooms Grid -->
  <div class="rooms" *ngIf="!isLoading">
    <div
      class="card"
      (click)="viewRoomDetail(room.roomID)"
      *ngFor="let room of displayedRooms; trackBy: trackByRoomId"
      [attr.data-room-id]="room.roomID"
    >
      <div class="image">
        <img
          aria-label="Room image"
          [src]="room.urlImage"
          [alt]="'Room ' +
        room.roomNumber"
          (error)="handleImageError(room)"
          loading="lazy"
        />
        <!-- Status badge -->
        <div class="status-badge" [ngClass]="'status-' + room.status">
          {{ room.status }}
        </div>
      </div>
      <div class="info">
        <div class="section-room-status">
          <span
            class="icon-status"
            [ngClass]="{
              'status-Available': room.status === 'Available',
              'status-Occupied': room.status === 'Occupied',
              'status-Maintenance': room.status === 'Maintenance'
            }"
          ></span>
          <label>{{ room.status }}</label>
        </div>
        <div class="groupPrice">
          <h4 class="buildingID">Building: {{ room.buildingName }}</h4>
        </div>
        <div class="section-room-number">
          <h4 class="roomID">Code: {{ room.roomNumber }}</h4>
        </div>
        <div class="section-price">
          <span class="material-symbols-outlined">money_bag</span>
          <label class="price">{{ room.price | number: "1.0-0" }} VND</label>
        </div>
        <div class="section-avatars" *ngIf="room.urlAvatars.length > 0">
          <div class="imgs">
            <img
              *ngFor="let item of room.urlAvatars | slice: 0:4; let i = index"
              [src]="item"
              alt="Avatar"
              (error)="handleAvatarError(room, i)"
              loading="lazy"
            />
            <span
              *ngIf="room.urlAvatars.length > 4"
              class="more-avatars"
              (click)="showMoreAvatars(room); $event.stopPropagation()"
              matTooltip="View more avatars"
            >
              +{{ room.urlAvatars.length - 4 }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="displayedRooms.length === 0" class="empty-state">
      <mat-icon>home</mat-icon>
      <h3>No rooms found</h3>
      <p
        *ngIf="searchText || buildingCode || minPrice > sliderMin || maxPrice < sliderMax"
      >
        Try adjusting your search or filter criteria
      </p>
      <p
        *ngIf="!searchText && !buildingCode && minPrice <= sliderMin && maxPrice >= sliderMax"
      >
        No rooms available at the moment
      </p>
      <button
        mat-stroked-button
        (click)="clearFilters()"
        *ngIf="searchText || buildingCode || minPrice > sliderMin || maxPrice < sliderMax"
      >
        Clear Filters
      </button>
    </div>
  </div>

  <!-- Pagination -->
  <div
    class="pagination-container"
    *ngIf="!isLoading && totalFilteredRooms > pageSize"
  >
    <mat-paginator
      [length]="totalFilteredRooms"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      [pageIndex]="currentPage"
      (page)="onPageChange($event)"
      showFirstLastButtons
    >
    </mat-paginator>
  </div>

  <!-- Filter Panel -->
  <div class="filter-panel" [class.open]="isFilterPanelOpen" #filterPanel>
    <div class="filter-header">
      <h3>Filter Options</h3>
      <button mat-icon-button (click)="toggleFilter($event)" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="filter-stats" *ngIf="!isLoading">
      <p>
        {{ totalFilteredRooms }} of {{ allRooms.length }} rooms match your
        criteria
      </p>
    </div>

    <div class="btn-container">
      <button mat-raised-button color="primary" (click)="applyFilters()">
        <mat-icon>filter_list</mat-icon>
        Apply Filters
      </button>
      <button mat-stroked-button (click)="clearFilters()">
        <mat-icon>clear</mat-icon>
        Clear All
      </button>
    </div>

    <div class="filter-container">
      <!-- Building Dropdown -->
      <div class="filter-section">
        <h4>Building</h4>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Select Building</mat-label>
          <mat-select
            [(value)]="buildingCode"
            (selectionChange)="onBuildingChange()"
          >
            <mat-option
              *ngFor="let option of options"
              [value]="option.buildingID"
            >
              {{ option.buildingName }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Price Range Slider -->
      <div class="filter-section">
        <h4>Price Range</h4>
        <div class="price-display">
          <span class="price-label">
            {{ minPrice | number: "1.0-0" }} - {{ maxPrice | number: "1.0-0" }}
            VND
          </span>
        </div>
        <mat-slider
          [min]="sliderMin"
          [max]="sliderMax"
          [step]="100000"
          [discrete]="true"
          class="price-slider"
        >
          <input
            aria-label="Minimum price"
            [(value)]="minPrice"
            (input)="onPriceRangeChange()"
            matSliderStartThumb
          />
          <input
            aria-label="Maximum price"
            [(value)]="maxPrice"
            (input)="onPriceRangeChange()"
            matSliderEndThumb
          />
        </mat-slider>
        <div class="price-range-labels">
          <span>{{ sliderMin | number: "1.0-0" }}</span>
          <span>{{ sliderMax | number: "1.0-0" }}</span>
        </div>
      </div>

      <!-- Quick Filters -->
      <div class="filter-section">
        <h4>Quick Filters</h4>
        <div class="quick-filters">
          <button
            mat-stroked-button
            [color]="searchText.includes('Available') ? 'primary' : ''"
            (click)="resetSearch('Available',{target: {value: 'Available'}})"
          >
            Available Only
          </button>
          <button
            mat-stroked-button
            [color]="minPrice === sliderMax * 0.8 ? 'primary' : ''"
            (click)="minPrice = sliderMax * 0.8; onPriceRangeChange()"
          >
            Premium Rooms
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay for mobile -->
  <div
    class="filter-overlay"
    [class.show]="isFilterPanelOpen"
    (click)="toggleFilter()"
  ></div>
</div>
