<div class="create-room-dialog">
  <div class="dialog-header">
    <h2 mat-dialog-title>
      <mat-icon>add_home</mat-icon>
      Create New Room
    </h2>
    <button mat-icon-button mat-dialog-close>
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content class="dialog-content">
    <form [formGroup]="roomForm" class="room-form">
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>info</mat-icon>
          Basic Information
        </h3>
        <div class="form-row">
          <!-- Chọn tòa nhà (Multiple Select) -->
          <mat-form-field
            appearance="outline"
            class="form-field selectBuilding"
          >
            <mat-label>Building</mat-label>
            <mat-select formControlName="buildingID">
              <mat-select-trigger>
                {{ selectedBuildingName }}
              </mat-select-trigger>
              <mat-option
                *ngFor="let building of _buildings"
                [value]="building.buildingID"
              >
                <div class="building-option">
                  <span class="building-name">
                    {{ building.buildingName }}
                  </span>

                  <span class="building-address">
                    {{ building.buildingAddress }}
                  </span>
                </div>
              </mat-option>
            </mat-select>
            <mat-hint>You can select multiple buildings</mat-hint>
            <mat-error *ngIf="roomForm.get('buildingID')?.hasError('required')">
              Please select at least one building
            </mat-error>
          </mat-form-field>

          <!-- Số phòng -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Room Number</mat-label>
            <input
              #roomNumberInput
              matInput
              formControlName="roomNumber"
              placeholder="VD: P101, A201"
            />
            <mat-error *ngIf="roomForm.get('roomNumber')?.hasError('required')">
              Room number is required
            </mat-error>
            <mat-error *ngIf="roomForm.get('roomNumber')?.hasError('pattern')">
              Room number can only contain letters and numbers
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <!-- Diện tích -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Area (m²)</mat-label>
            <input
              matInput
              type="number"
              formControlName="area"
              placeholder="25"
            />
            <mat-hint>Area in square meters</mat-hint>
            <mat-error *ngIf="roomForm.get('area')?.hasError('required')">
              Area is required
            </mat-error>
            <mat-error *ngIf="roomForm.get('area')?.hasError('min')">
              Area must be greater than 0
            </mat-error>
            <mat-error *ngIf="roomForm.get('area')?.hasError('max')">
              Area must not exceed 1000m²
            </mat-error>
          </mat-form-field>

          <!-- Giá tiền -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Rent (VNĐ/Month)</mat-label>
            <input
              matInput
              type="number"
              formControlName="price"
              placeholder="3500000"
            />
            <mat-hint>Monthly rental price</mat-hint>
            <mat-error *ngIf="roomForm.get('price')?.hasError('required')">
              Giá thuê là bắt buộc
            </mat-error>
            <mat-error *ngIf="roomForm.get('price')?.hasError('min')">
              Rent must be greater than or equal to 0
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <!-- Max Guests -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Max Guests (m²)</mat-label>
            <input
              matInput
              type="number"
              formControlName="area"
              placeholder="25"
            />
            <mat-hint>Area in square meters</mat-hint>
            <mat-error *ngIf="roomForm.get('area')?.hasError('required')">
              Area is required
            </mat-error>
            <mat-error *ngIf="roomForm.get('area')?.hasError('min')">
              Area must be greater than 0
            </mat-error>
            <mat-error *ngIf="roomForm.get('area')?.hasError('max')">
              Area must not exceed 1000m²
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Mô tả -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea
            matInput
            formControlName="description"
            rows="3"
            placeholder="Detailed description of the room..."
          >
          </textarea>
          <mat-hint>
            {{ roomForm.get('description')?.value?.length || 0 }}/1000
            characters
          </mat-hint>
          <mat-error *ngIf="roomForm.get('description')?.hasError('maxlength')">
            Description must not exceed 1000 characters
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Hình ảnh -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>photo_library</mat-icon>
          Room image ({{ roomImages.length }}/{{ maxImages }})
        </h3>

        <!-- Upload area -->
        <div class="upload-area">
          <input
            type="file"
            #fileInput
            (change)="onFileSelected($event)"
            multiple
            accept="image/*"
            style="display: none"
          />

          <button
            type="button"
            mat-raised-button
            color="primary"
            (click)="fileInput.click()"
            [disabled]="roomImages.length >= maxImages"
          >
            <mat-icon>cloud_upload</mat-icon>
            Upload
          </button>

          <div class="upload-info">
            <p>Select up to {{ maxImages }} images</p>
            <p>Format: JPG, PNG, WEBP. Maximum 5MB/image</p>
          </div>
        </div>

        <!-- Image preview -->
        <div class="image-preview" *ngIf="roomImages.length > 0">
          <div class="image-grid">
            <div
              *ngFor="let image of roomImages"
              class="image-item"
              [class.thumb-image]="image.isThumb"
            >
              <div class="image-container">
                <img
                  aria-label="room image"
                  [src]="image.url"
                  [alt]="image.name"
                />

                <!-- Image overlay -->
                <div class="image-overlay">
                  <button
                    type="button"
                    mat-icon-button
                    class="thumb-btn"
                    [class.active]="image.isThumb"
                    (click)="setAsThumb(image.id)"
                    matTooltip="Set as avatar"
                  >
                    <mat-icon>
                      {{ image.isThumb ? 'star' : 'star_border' }}
                    </mat-icon>
                  </button>

                  <button
                    type="button"
                    mat-icon-button
                    class="delete-btn"
                    (click)="removeImage(image.id)"
                    matTooltip="Delete Image"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>

              <div class="image-info">
                <span class="image-name">{{ image.name }}</span>
                <span class="image-size">{{ formatFileSize(image.size) }}</span>
                <mat-chip *ngIf="image.isThumb" color="primary" selected>
                  <mat-icon>star</mat-icon>
                  Avatar
                </mat-chip>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty state -->
        <div class="empty-images" *ngIf="roomImages.length === 0">
          <mat-icon>photo_library</mat-icon>
          <p>No photos uploaded yet</p>
        </div>
      </div>

      <!-- Tài sản -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>inventory_2</mat-icon>
          Room assets ({{ selectedAssets.length }} selected)
        </h3>

        <div class="assets-container">
          <div
            *ngFor="let assetType of getAssetTypes()"
            class="asset-type-group"
          >
            <h4 class="asset-type-title">{{ assetType }}</h4>

            <div class="asset-grid">
              <mat-checkbox
                *ngFor="let asset of getAssetsByType(assetType)"
                [checked]="isAssetSelected(asset.assetID)"
                (change)="onAssetChange(asset.assetID, $event.checked)"
                class="asset-checkbox"
              >
                <div class="asset-info">
                  <span class="asset-name">{{ asset.name }}</span>
                </div>
              </mat-checkbox>
            </div>
          </div>
        </div>

        <!-- Selected assets summary -->
        <div class="selected-assets" *ngIf="selectedAssets.length > 0">
          <h4>Selected assets:</h4>
          <div class="selected-asset-chips">
            <mat-chip
              *ngFor="let assetId of selectedAssets"
              color="primary"
              selected
              (removed)="onAssetChange(assetId, false)"
              removable
            >
              {{ getAssetName(assetId) }}
              <mat-icon matChipRemove>cancel</mat-icon>
            </mat-chip>
          </div>
        </div>
      </div>

      <!-- Preview -->
      <div class="form-section" *ngIf="roomForm.valid">
        <h3 class="section-title">
          <mat-icon>preview</mat-icon>
          Preview
        </h3>

        <mat-card class="preview-card">
          <mat-card-content>
            <div class="preview-item">
              <strong>Building:</strong>
              {{ getSelectedBuildingName() }}
            </div>
            <div class="preview-item">
              <strong>Room number:</strong>
              {{ roomForm.get('roomNumber')?.value }}
            </div>
            <div class="preview-item">
              <strong>Area:</strong> {{ roomForm.get('area')?.value }}m²
            </div>
            <div class="preview-item">
              <strong>Price per month:</strong>
              {{ formatPrice(roomForm.get('price')?.value) }}
            </div>
            <div
              class="preview-item"
              *ngIf="roomForm.get('description')?.value"
            >
              <strong>Mô tả:</strong>
              {{ roomForm.get('description')?.value }}
            </div>
            <div class="preview-item">
              <strong>Number of photos:</strong>
              {{ roomImages.length }}
            </div>
            <div class="preview-item">
              <strong>Number of assets:</strong>
              {{ selectedAssets.length }}
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions class="dialog-actions">
    <button mat-button (click)="onCancel()" [disabled]="isLoading">
      <mat-icon>cancel</mat-icon>
      Cancel
    </button>
    <button
      mat-raised-button
      color="primary"
      (click)="onSave()"
      [disabled]="!roomForm.valid || isLoading"
    >
      <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
      <mat-icon *ngIf="!isLoading">save</mat-icon>
      {{ isLoading ? 'Creating...' : 'Create' }}
    </button>
  </mat-dialog-actions>
</div>
